<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="CodeMapper">
	
	<select id="selectBasicCode" resultType="map">
		SELECT * FROM (
			SELECT 
				BASIC_CD 
				,CD_NM 
				,CD_VALUE 
				,CD_DESCRIPTION 
				,USE_YN 
				,BOM_CD
				,REG_DT 
				,REG_ID 
				,UDT_DT 
				,UDT_ID 
				,BOM_CD.ToString() as BOM_TEXT
				,BOM_CD.GetLevel() as BOM_LEV 
				,BOM_CD.GetAncestor(1).ToString() AS PARENTBOM 
			 FROM TB_BASIC_CD ) CODE
		WHERE CODE.PARENTBOM = #{PARENTBOM}
		ORDER BY CODE.BOM_CD , CODE.BOM_LEV
	</select>
	
	<update id="saveBasicCode" parameterType="map">
		MERGE TB_BASIC_CD BASIC
		USING (SELECT #{BASIC_CD} AS BASIC_CD ) TARGET
		   ON (BASIC.BASIC_CD = TARGET.BASIC_CD)
		 WHEN MATCHED THEN
		 UPDATE 
		    SET CD_NM = #{CD_NM}
		      , CD_VALUE = #{CD_VALUE}
		      , CD_DESCRIPTION = #{CD_DESCRIPTION}
		      , USE_YN = #{USE_YN}
		      , UDT_DT = GETDATE()
		      , UDT_ID = #{SESSION.USERID}
		 WHEN NOT MATCHED THEN
		 INSERT (BOM_CD,BASIC_CD,CD_NM,CD_VALUE,CD_DESCRIPTION,USE_YN,REG_ID,UDT_ID,REG_DT,UDT_DT)
		 VALUES (
		 	(SELECT BOM_CD.GetDescendant((SELECT MAX(BOM_CD) FROM TB_BASIC_CD WHERE BOM_CD.GetAncestor(1) = #{PARENTBOM}), NULL) FROM TB_BASIC_CD WHERE BOM_CD = #{PARENTBOM})
       		,#{BASIC_CD},#{CD_NM},#{CD_VALUE},#{CD_DESCRIPTION},#{USE_YN},#{session.userId},#{session.userId},GETDATE(),GETDATE()
       	 );
	</update>
	
	<delete id="deleteBasicCode" parameterType="map">
		DELETE FROM TB_BASIC_CD 
		 WHERE BOM_CD = #{BOM_CD}
	</delete>
	
</mapper>