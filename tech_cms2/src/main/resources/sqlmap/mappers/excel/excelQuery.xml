<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="ExcelhMapper">
	
    <select id="selectUserInfo" resultType="map">
        SELECT USER_ID 
          FROM TB_MEMBER_ID 
         WHERE USER_ID = #{PANEL_ID}
    </select>
    
    <!-- TB_PANEL_REG_TEST (panel data Insert) -->
    <update id="savePanelValueList" parameterType="map">
		MERGE TB_PANEL_REG TDATA
		USING (SELECT #{IDX_DD} AS IDX_DD, #{IDX_CATE_ID} AS IDX_CATE_ID, (SELECT USER_ID FROM TB_MEMBER_ID WHERE USER_ID = #{PANEL_ID}) AS PANEL_ID) TARGET
		   ON (TDATA.IDX_DD = TARGET.IDX_DD AND TDATA.IDX_CATE_ID = TARGET.IDX_CATE_ID AND TDATA.PANEL_ID = TARGET.PANEL_ID)
		 WHEN MATCHED THEN
	   UPDATE SET 
	          IDX_VALUE = ISNULL(#{IDX_VALUE, jdbcType=NUMERIC}, 0)
			  , UDT_ID = 'ADMIN'
			  , UDT_DT = GetDate()
		 WHEN NOT MATCHED THEN
	   INSERT (IDX_CATE_ID, IDX_DD, PANEL_ID, IDX_VALUE, REG_ID, REG_DT)
	   VALUES (
			#{IDX_CATE_ID},
			#{IDX_DD},
			#{PANEL_ID},
			ISNULL(#{IDX_VALUE, jdbcType=NUMERIC}, 0),
			'ADMIN',
			GetDate()); 	    
	</update>
	
    <!-- TB_IDX_TEST (average Insert) -->
    <update id="saveAverageList" parameterType="map">
        MERGE TB_IDX TDATA
		USING (SELECT #{IDX_DD} AS IDX_DD, #{IDX_CATE_ID} AS IDX_CATE_ID) TARGET
		   ON (TDATA.IDX_DD = TARGET.IDX_DD AND TDATA.IDX_CATE_ID = TARGET.IDX_CATE_ID)
		 WHEN MATCHED THEN
	   UPDATE SET 
	          IDX_VALUE = ISNULL(#{IDX_VALUE, jdbcType=NUMERIC}, 0)
			  , UDT_ID = 'ADMIN'
			  , UDT_DT = GetDate()
		 WHEN NOT MATCHED THEN
	   INSERT (IDX_CATE_ID, IDX_DD, IDX_VALUE, REG_ID, REG_DT)
	   VALUES (
			#{IDX_CATE_ID},
			#{IDX_DD},
			ISNULL(#{IDX_VALUE, jdbcType=NUMERIC}, 0),
			'ADMIN',
			GetDate()); 
    </update>
		
</mapper>