<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="SurveyMapper">
	
	<select id="selectSurveyList" resultType="map">
	    SELECT SURVEY_ID
	    	 , SURVEY_NM
	    	 , SURVEY_CONT
	    	 , SURVEY_IMG
	    	 , SURVEY_TARGET
	    	 , SURVEY_MAIN
	    	 , convert(varchar, SURVEY_STARTDT, 111) AS SURVEY_STARTDT
	    	 , convert(varchar, SURVEY_ENDDT, 111) AS SURVEY_ENDDT
	    	 , convert(varchar, INS_DATE, 120) AS INS_DATE
	    	 , INS_ID
	    	 , convert(varchar, UPT_DATE, 120) AS UPT_DATE
	    	 , UPT_ID
	    	 , ISNULL(DEL_GBN, 0) AS DEL_GBN
	    	 , convert(varchar, DEL_DATE, 120) AS DEL_DATE
	    	 , DEL_ID
	     FROM TB_SURVEY_MASTER
	    WHERE 1=1
	      AND DEL_GBN != 1 
	    <if test="SURVEY_NM != null and !SURVEY_NM.equals('')">
          AND LOWER(SURVEY_NM) LIKE LOWER('%' + #{SURVEY_NM} + '%')
       	</if>
       	<if test="SURVEY_ID != null and !SURVEY_ID.equals('')">
          AND SURVEY_ID = #{SURVEY_ID}
       	</if>
	</select>
	
	<!-- TB_SURVEY_DETAIL 조회 -->
	<select id="selectSurveyDetailList" resultType="map">
	    SELECT MASTER.SURVEY_NM
	         , MASTER.SURVEY_CONT
	         , MASTER.SURVEY_IMG
	         , MASTER.SURVEY_TARGET
	         , MASTER.SURVEY_MAIN
	         , MASTER.SURVEY_STARTDT
	         , MASTER.SURVEY_ENDDT
	         , DETAIL.SURVEY_ID
	         , DETAIL.SURVEY_DID
	         , DETAIL.SURVEY_NO
	         , DETAIL.SURVEY_DNO
	         , DETAIL.SURVEY_CONTENT
	         , DETAIL.SURVEY_TYPE
	      FROM TB_SURVEY_MASTER MASTER JOIN TB_SURVEY_DETAIL DETAIL
	        ON MASTER.SURVEY_ID = DETAIL.SURVEY_ID
	     WHERE 1=1
	      AND ISNULL(DETAIL.DEL_GBN,0) != 1
	    <if test="SURVEY_ID != null and !SURVEY_ID.equals('')">
          AND DETAIL.SURVEY_ID = #{SURVEY_ID}
       	</if>
	    <if test="SURVEY_DID != null and !SURVEY_DID.equals('')">
          AND DETAIL.SURVEY_DID = #{SURVEY_DID}
       	</if>
       	ORDER BY MASTER.SURVEY_NM, DETAIL.SURVEY_NO, DETAIL.SURVEY_DNO 
	</select>
	
	<!-- TB_SURVEY_DETAIL_EXAMPLE 조회 -->
	<select id="selectSurveyDetailExampleList" resultType="map">
	    SELECT MASTER.SURVEY_NM
	         , MASTER.SURVEY_CONT
	         , MASTER.SURVEY_IMG
	         , MASTER.SURVEY_TARGET
	         , MASTER.SURVEY_MAIN
	         , MASTER.SURVEY_STARTDT
	         , MASTER.SURVEY_ENDDT
	         , DETAIL.SURVEY_DID
	         , DETAIL.SURVEY_NO
	         , DETAIL.SURVEY_DNO
	         , DETAIL.SURVEY_CONTENT
	         , DETAIL.SURVEY_TYPE
	         , EXAMPLE.SURVEY_DE_ID
	         , EXAMPLE.SURVEY_DE_NO
	         , EXAMPLE.SURVEY_CONTENT AS E_SURVEY_CONTENT
	         , EXAMPLE.SURVEY_ETC AS E_SURVEY_ETC
	         , EXAMPLE.SURVEY_SCORE AS E_SURVEY_SCORE
	         , EXAMPLE.DEL_ID
	         , EXAMPLE.INS_DATE
	         , EXAMPLE.INS_ID
	         , EXAMPLE.UPT_DATE
	         , EXAMPLE.UPT_ID
	         , EXAMPLE.DEL_GBN
	         , EXAMPLE.DEL_DATE
	      FROM TB_SURVEY_MASTER MASTER JOIN TB_SURVEY_DETAIL DETAIL
	        ON MASTER.SURVEY_ID = DETAIL.SURVEY_ID
	      JOIN TB_SURVEY_DETAIL_EXAMPLE EXAMPLE
	        ON DETAIL.SURVEY_DID = EXAMPLE.SURVEY_DID
	       AND DETAIL.SURVEY_ID = EXAMPLE.SURVEY_ID 
	     WHERE 1=1
	       AND ISNULL(DETAIL.DEL_GBN,0) != 1
	       AND ISNULL(EXAMPLE.DEL_GBN,0) != 1
	    <if test="SURVEY_ID != null and !SURVEY_ID.equals('')">
          AND EXAMPLE.SURVEY_ID = #{SURVEY_ID}
       	</if>
	    <if test="SURVEY_DID != null and !SURVEY_DID.equals('')">
          AND EXAMPLE.SURVEY_DID = #{SURVEY_DID}
       	</if>
       	<if test="SURVEY_DE_ID != null and !SURVEY_DE_ID.equals('')">
          AND EXAMPLE.SURVEY_DE_ID = #{SURVEY_DE_ID}
       	</if>
       	ORDER BY MASTER.SURVEY_NM, DETAIL.SURVEY_NO, DETAIL.SURVEY_DNO, EXAMPLE.SURVEY_DE_NO 
	</select>
	
	<!-- 삭제 -->
	<delete id="deleteSurveyList" parameterType="map">
	    UPDATE TB_SURVEY_MASTER
	       SET DEL_GBN = '1'
	         , DEL_DATE = GetDate()
	         , DEL_ID = #{session.userId, jdbcType=VARCHAR}
	    WHERE SURVEY_ID = #{SURVEY_ID}
	</delete>
	
	<!-- 수정 -->
	<update id="updateSurveyList" parameterType="map">
	    UPDATE TB_SURVEY_MASTER
	       SET SURVEY_NM = #{SURVEY_NM, jdbcType=VARCHAR}
	         , SURVEY_CONT = #{SURVEY_CONT, jdbcType=VARCHAR}
	         , SURVEY_IMG = #{SURVEY_IMG, jdbcType=VARCHAR}
	         , SURVEY_TARGET = #{SURVEY_TARGET, jdbcType=VARCHAR}
	         , SURVEY_MAIN = #{SURVEY_MAIN, jdbcType=VARCHAR}
	         , SURVEY_STARTDT = #{SURVEY_STARTDT, jdbcType=VARCHAR}
	         , SURVEY_ENDDT = #{SURVEY_ENDDT, jdbcType=VARCHAR}
	         , UPT_ID = #{session.userId, jdbcType=VARCHAR}
	         , UPT_DATE = GetDate()
	    WHERE SURVEY_ID = #{SURVEY_ID}
	</update>
	
	<!-- 신규 -->
	<insert id="insertSurveyList" parameterType="map">
	    INSERT INTO TB_SURVEY_MASTER (	    	
	    	SURVEY_NM,
	    	SURVEY_CONT,
	    	SURVEY_IMG,
	    	SURVEY_TARGET,
	    	SURVEY_MAIN,
	    	SURVEY_STARTDT,
	    	SURVEY_ENDDT,
	    	INS_DATE,
	    	INS_ID,
	    	DEL_GBN
	    )VALUES(
	    	#{SURVEY_NM, jdbcType=VARCHAR},
	    	#{SURVEY_CONT, jdbcType=VARCHAR},
	    	#{SURVEY_IMG, jdbcType=VARCHAR},
	    	#{SURVEY_TARGET, jdbcType=VARCHAR},
	    	#{SURVEY_MAIN, jdbcType=VARCHAR},
	    	#{SURVEY_STARTDT, jdbcType=VARCHAR},
	    	#{SURVEY_ENDDT, jdbcType=VARCHAR},
	    	GetDate(),
	    	#{session.userId, jdbcType=VARCHAR},
	    	'0'
	    )
	</insert>
	
	<select id="selectSurveyDetailMaxNoList" resultType="map">
	    SELECT MASTER.SURVEY_NM
	         , MASTER.SURVEY_CONT
	         , MASTER.SURVEY_IMG
	         , MASTER.SURVEY_TARGET
	         , MASTER.SURVEY_MAIN
	         , MASTER.SURVEY_STARTDT
	         , MASTER.SURVEY_ENDDT
	         , DETAIL.SURVEY_ID
	         , DETAIL.SURVEY_DID
	         , DETAIL.SURVEY_NO
	         , DETAIL.SURVEY_DNO
	         , DETAIL.SURVEY_CONTENT
	         , DETAIL.SURVEY_TYPE
	      FROM TB_SURVEY_MASTER MASTER JOIN TB_SURVEY_DETAIL DETAIL
	        ON MASTER.SURVEY_ID = DETAIL.SURVEY_ID
	     WHERE 1=1
	      AND ISNULL(DETAIL.DEL_GBN,0) != 1
	    <if test="SURVEY_ID != null and !SURVEY_ID.equals('')">
          AND DETAIL.SURVEY_ID = #{SURVEY_ID}
       	</if>
       	  AND DETAIL.SURVEY_NO = (SELECT MAX(SURVEY_NO) FROM TB_SURVEY_DETAIL WHERE ISNULL(DEL_GBN,0) != 1 AND SURVEY_ID = #{SURVEY_ID})
	</select>
	
	<!-- ================================== 설문 조사에 대한 엑셀 다운로드 관련 쿼리 =============================== -->
	
	<!-- 해당 설문에 대한 총 사용자 명단 및 count -->
	<select id="selectCntUserResultList" resultType="map">
	    SELECT COUNT(T.Survey_User_ID) AS CNT
	 		 , STUFF(( SELECT ', ' + P.Survey_User_ID
                 		 FROM TB_SURVEY_USER_DETAIL P
               			WHERE (P.SURVEY_ID = T.SURVEY_ID)
               	  		  FOR XML PATH ('')),1,1,'') AS USER_NMS
  		  FROM TB_SURVEY_USER_DETAIL T   
 		 WHERE 1=1
 		 <if test="SURVEY_ID != null and !SURVEY_ID.equals('')">
           AND T.SURVEY_ID = #{SURVEY_ID}
       	</if>
 		 GROUP BY T.SURVEY_ID
	</select>
	
	<!-- 해당 설문에 대한 사용자 명단과 작성 시간 -->
	<select id="selectUserResultInsertList" resultType="map">
	    SELECT SURVEY_ID
	    	 , SURVEY_USER_ID
	    	 , INS_DATE
  		  FROM TB_SURVEY_USER_DETAIL   
 		 WHERE 1=1
 		 <if test="SURVEY_ID != null and !SURVEY_ID.equals('')">
           AND SURVEY_ID = #{SURVEY_ID}
       	</if>
 		 ORDER BY INS_DATE
	</select>
	
	<!-- 해당 설문에 대한 보기 항목 조회 -->
	<select id="selectSurveyDetailAllList" resultType="map">
	    SELECT SURVEY_ID
	 		 , SURVEY_DID
	 		 , SURVEY_NO
	 		 , SURVEY_DNO
	 		 , SURVEY_CONTENT
	 		 , SURVEY_TYPE
	 	 FROM TB_SURVEY_DETAIL
 		WHERE ISNULL(DEL_GBN, 0) != 1
   		<if test="SURVEY_ID != null and !SURVEY_ID.equals('')">
          AND SURVEY_ID = #{SURVEY_ID}
       	</if>
 		ORDER BY SURVEY_NO ASC, SURVEY_DNO ASC
	</select>
	
	<!-- TB_SURVEY_USER_DETAIL 결과 조회 -->
	<select id="selectSurveyUserAnswerAllList" resultType="map">
	    SELECT A.*, ISNULL(B.CNT, 0) AS CNT
	    	 , (SELECT COUNT(DISTINCT SURVEY_USER_ID)
	    	 	  FROM TB_SURVEY_USER_RESULT 
				 WHERE SURVEY_ID = A.SURVEY_ID 
				   AND SURVEY_DID = A.SURVEY_DID) AS U_CNT
	    	 , ISNULL(B.PLAYERS, '') AS PLAYERS
  		  FROM (SELECT MASTER.SURVEY_NM
  		  	         , MASTER.SURVEY_CONT
  		  	         , MASTER.SURVEY_IMG
  		  	         , MASTER.SURVEY_TARGET
  		  	         , MASTER.SURVEY_MAIN
  		  	         , MASTER.SURVEY_STARTDT
  		  	         , MASTER.SURVEY_ENDDT
  		  			 , MASTER.Survey_ID
  		  	         , DETAIL.SURVEY_DID
  		  	         , DETAIL.SURVEY_NO
  		  	         , DETAIL.SURVEY_DNO
  		  	         , DETAIL.SURVEY_CONTENT
  		  	         , DETAIL.SURVEY_TYPE
  		  	         , EXAMPLE.SURVEY_DE_ID
  		  	         , EXAMPLE.SURVEY_DE_NO
  		  	         , EXAMPLE.SURVEY_CONTENT AS E_SURVEY_CONTENT
  		  	         , EXAMPLE.SURVEY_ETC AS E_SURVEY_ETC
  		  	         , EXAMPLE.SURVEY_SCORE AS E_SURVEY_SCORE
  		  	         , EXAMPLE.DEL_ID
  		  	         , EXAMPLE.INS_DATE
  		  	         , EXAMPLE.INS_ID
  		  	         , EXAMPLE.UPT_DATE
  		  	         , EXAMPLE.UPT_ID
  		  	         , EXAMPLE.DEL_GBN
  		  	         , EXAMPLE.DEL_DATE
  		  	      FROM TB_SURVEY_MASTER MASTER JOIN TB_SURVEY_DETAIL DETAIL
  		  	        ON MASTER.SURVEY_ID = DETAIL.SURVEY_ID
  		  	      JOIN TB_SURVEY_DETAIL_EXAMPLE EXAMPLE
  		  	        ON DETAIL.SURVEY_DID = EXAMPLE.SURVEY_DID
  		  	       AND DETAIL.SURVEY_ID = EXAMPLE.SURVEY_ID 
  		  	     WHERE 1=1
  		  	       AND ISNULL(DETAIL.DEL_GBN,0) != 1
  		  	       AND ISNULL(EXAMPLE.DEL_GBN,0) != 1
  		  	    <if test="SURVEY_ID != null and !SURVEY_ID.equals('')">
  		           AND EXAMPLE.SURVEY_ID = #{SURVEY_ID}
  		        </if>
  		        <if test="SURVEY_DID != null and !SURVEY_DID.equals('')">
          		  AND EXAMPLE.SURVEY_DID = #{SURVEY_DID}
       			</if>
       			<if test="SURVEY_DE_ID != null and !SURVEY_DE_ID.equals('')">
          		  AND EXAMPLE.SURVEY_DE_ID = #{SURVEY_DE_ID}
       			</if>) A
  		  LEFT OUTER JOIN (SELECT SUM(A.CNT) AS CNT, A.U_CNT, A.Survey_DE_ID, A.Survey_DID, A.Survey_ID, A.PLAYERS
  		    				 FROM (SELECT COUNT(T.Survey_DE_ID) AS CNT, T.Survey_DE_ID, T.Survey_DID, T.Survey_ID, T.Survey_DE_ETC
  		    				 			, (SELECT COUNT(DISTINCT SURVEY_USER_ID) AS U_CNT FROM TB_SURVEY_USER_RESULT 
											WHERE SURVEY_ID = T.SURVEY_ID 
											  AND SURVEY_DID = T.SURVEY_DID) AS U_CNT									
										, CASE WHEN T.Survey_DE_ETC = '' THEN ''
			     							   ELSE STUFF(( SELECT ', ' + P.Survey_User_ID + ' 답변 : ' + P.Survey_DE_ETC
               												  FROM TB_SURVEY_USER_RESULT P
               												 WHERE (P.SURVEY_ID = T.SURVEY_ID AND T.Survey_DID = P.Survey_DID)
               										FOR XML PATH ('')),1,1,'') END AS PLAYERS
				  					 FROM TB_SURVEY_USER_RESULT T
				 					WHERE 1=1
				 					<if test="SURVEY_ID != null and !SURVEY_ID.equals('')">
  		           					  AND T.SURVEY_ID = #{SURVEY_ID}
  		        					</if>
				 				    GROUP BY T.Survey_DE_ID, T.Survey_DID, T.Survey_ID, T.Survey_DE_ETC) A
 							GROUP BY A.Survey_DE_ID, A.Survey_DID, A.Survey_ID, A.PLAYERS, A.U_CNT) B
   			ON A.Survey_ID = B.Survey_ID
   		   AND A.Survey_DID = B.Survey_DID
   		   AND A.Survey_DE_ID = B.Survey_DE_ID
   		   AND (CASE WHEN A.SURVEY_TYPE = 'S' AND B.PLAYERS = '' THEN '0'
					 WHEN A.SURVEY_TYPE = 'S' AND B.PLAYERS != '' THEN '1'
					 WHEN A.SURVEY_TYPE = 'MM' THEN '1'
					 WHEN A.SURVEY_TYPE = 'MO' THEN '1'
		    END)  = '1'
		  ORDER BY A.SURVEY_NM, A.SURVEY_NO, A.SURVEY_DNO, A.SURVEY_DE_NO
	</select>
	    
	
</mapper>